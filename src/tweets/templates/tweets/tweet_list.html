{% extends "base.html" %}

{% block titile %} {{ block.super }} Tweets {% endblock titile %}

{% block script %}

<script type="text/javascript">

    function getParameterByName(name, url) {
        if (!url) {
          url = window.location.href;
        }
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    function parseTweet(data){
        if(data == 0){
            $('#tweet-container').append(
                '<p>No tweets found!</p>'
            )
        }else{
            $.each(data, function(key, value){
                var tweet_key = value.key;
                var tweet_user = value.user;
                var tweet_content = value.content;
                $('#tweet-container').append(
                    '<div class="media">\
                      <div class="media-body">\
                        <p>' + tweet_content + '</p>\
                        from <i>' + tweet_user.username + '</i> |  ago | <a href="#"> view </a></p>\
                      </div>\
                    </div>\
                    <hr/>'
                )
            })
        }
    }

    $(document).ready(function(){
        console.log("Document Ready Function Working!");

        var query = getParameterByName('q');

        function fetchTweets(){
            console.log("Fetching..");
            $.ajax({
                url: "/api/tweet/",
                data:{
                    "q" : query
                },
                method: "GET",
                success: function(data){
                    // console.log(data);
                    parseTweet(data)     
                },
                error: function(data){
                    console.log("Error");
                    console.log(data);
                }
            })
        }

        fetchTweets()
        


        $("#tweet-form").submit(function(event){
            event.preventDefault()

            var this_ = $(this)
            var formData = this_.serialize()

            $.ajax({
                url: "/api/tweet/create/",
                data:formData,
                method: "POST",
                success: function(data){
                    console.log(data)
                    fetchTweets()  
                },
                error: function(data){
                    console.log("Error")
                    console.log(data)
                }
            })

            
        })
    });


    
</script>

{% endblock script %}

{% block content %}



    <div class="row">

        <div class= "col-sm-8 col-sm-offset-2">
            {% if not request.GET.q %}
            <div class="row">
                {% include "tweets/function_form.html" with form=create_form action_url=create_url btn_title="Tweet" form_id='tweet-form' %}
            </div>
            {% endif %}
            <hr/>

            <div id="tweet-container">
    

            </div>
            <!-- {% for object in object_list %}
            
                <div class="media">
                  {% if object.media %}
                  <img class="d-flex align-self-center mr-3" src="..." alt="Generic placeholder image">
                  {% endif %}
                  <div class="media-body">
                    <p>{{ object.content }}</p>
                    from <i> {{ object.user }}</i> | {{ object.timestamp|timesince }} ago | <a href="{{ object.get_absolute_url }}"> view </a></p>
                  </div>
                </div>
            <hr/>
            {% empty %}
                {% if request.GET.q %}
                <p>No tweets found!</p>
                {% else %}
                <p>No tweets yet!</p>
                {% endif %}
            {% endfor %} -->
        </div>
    </div>
{%  endblock content %}